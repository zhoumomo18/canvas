var canvasToImage = canvasToImage('white'); 

function canvasToImage(backgroundColor)
{
     
    var w = canvasX.width;
    var h = canvasX.height;

    var data;       

    if(backgroundColor)
    {

        data = context.getImageData(0, 0, w, h);


        var compositeOperation = context.globalCompositeOperation;

 
        context.globalCompositeOperation = "destination-over";

  
        context.fillStyle = backgroundColor;


        context.fillRect(0,0,w,h);
    }


    var imageData = this.canvas.toDataURL("image/png");

    if(backgroundColor)
    {
    
        context.clearRect (0,0,w,h);


        context.putImageData(data, 0,0);        

   
        context.globalCompositeOperation = compositeOperation;
    }


    return imageData;
}
